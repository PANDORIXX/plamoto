{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<!-- Page header -->
<div class="mb-4 text-center">
  <h1 class="display-5">Dashboard</h1>
</div>

<!-- Card displaying the latest image -->
<div class="row justify-content-center mb-5">
  <div class="col-md-8">
    <div class="card p-4">
      {% if latest_image %}
        <!-- Show latest image if available -->
        <h5 class="text-center mb-3">Latest image</h5>
        <img
          src="{{ url_for('static', filename='images/' + latest_image) }}"
          class="img-fluid mx-auto d-block"
          alt="Latest plant image"
        />
        <div class="mt-3 text-center">
          <!-- Button to capture a new image -->
          <a href="{{ url_for('capture') }}" class="btn btn-success" style="background-color:#c1ddc1; border:none; color:#000;">
            Capture new image
          </a>
        </div>
      {% else %}
        <!-- Message if no images exist yet -->
        <p class="text-center text-danger">No images available.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Toggle switch for background capture and its status -->
<div class="row justify-content-center mb-4">
  <div class="col-md-8 text-center">
    <h5 class="text-center mb-3">Background capture</h5>
    <div class="form-check form-switch d-inline-flex align-items-center gap-3">
      <!-- Checkbox for toggling background capture; checked if active -->
      <input class="form-check-input" type="checkbox" id="backgroundCaptureSwitch" {% if background_capture_active %}checked{% endif %}>
      <label class="form-check-label fw-semibold" for="backgroundCaptureSwitch">
        <div id="background_capture_status" class="status mt-2">
          {% if background_capture_active %}
            <span class="text-success">
              On – next image in {{ background_capture_next_in }} minutes
            </span>
          {% else %}
            <span class="text-danger">Off</span>
          {% endif %}
        </div>
      </label>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const toggleSwitch = document.getElementById("backgroundCaptureSwitch");
    const statusElem = document.getElementById("background_capture_status");

    // Function to fetch and update the background capture status from the server
    function updateStatus() {
      fetch("/background_capture_status")
        .then(response => response.json())
        .then(data => {
          if (data.active) {
            toggleSwitch.checked = true;
            statusElem.innerHTML = `<span class="text-success">
              On – next image in ${data.next_in} minutes
            </span>`;
          } else {
            toggleSwitch.checked = false;
            statusElem.innerHTML = `<span class="text-danger">Off</span>`;
          }
        })
        .catch(err => console.error("Failed to fetch background capture status:", err));
    }

    // Initial load of status on page load
    updateStatus();

    // Update status automatically every 60 seconds
    setInterval(updateStatus, 60000);

    // Event listener for toggle switch changes, triggers backend toggle
    toggleSwitch.addEventListener("change", () => {
      fetch("/toggle_background_capture", { method: "POST" })
        .then(response => response.json())
        .then(data => {
          if (data.active) {
            toggleSwitch.checked = true;
            statusElem.innerHTML = `<span class="text-success">
              On – next image in ${data.next_in} minutes
            </span>`;
          } else {
            toggleSwitch.checked = false;
            statusElem.innerHTML = `<span class="text-danger">Off</span>`;
          }
        })
        .catch(error => {
          // Revert toggle state on error and log it
          console.error("Error toggling background capture:", error);
          toggleSwitch.checked = !toggleSwitch.checked;
        });
    });
  });
</script>
{% endblock %}
